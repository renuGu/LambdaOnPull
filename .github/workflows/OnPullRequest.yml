name: Send git diff to Lambda

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  job-pass-diff-to-lambda:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get git diff
        run: |
          git diff origin/main...HEAD > diff.txt

      - name: Upload diff artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-diff
          path: diff.txt
      - name: Download diff artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-diff
          path: .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Invoke Lambda
        id: invoke_lambda
        run: |
          aws lambda invoke \
            --function-name arn:aws:lambda:us-east-2:772837503944:function:CallBedrockModel2 \
            --cli-binary-format raw-in-base64-out \
            --payload "$(jq -Rs '{diff: .}' diff.txt)" \
            response.json

      - name: Show Lambda response
        run: cat response.json
        
      - name: Pretty-print JSON
        run: |
          jq -R 'fromjson' response.json > response1.json

      - name: Upload analysis result
        uses: actions/upload-artifact@v4
        with:
          name: ai-code-analysis
          path: response1.json
      
      - name: Process Lambda Output to File
        env:
            # Safely pass the complex string as an environment variable
            #RAW_RESPONSE: ${{ steps.invoke_lambda.outputs.response }}
        run: |
            # 1. Extract the 'body' field and unescape it once
            # 2. Use 'grep' to keep only the lines that are actual JSON objects (starts with {)
            # 3. Use 'jq' to pretty-print the result into a file
            
            #echo "$RAW_RESPONSE" | jq -r '.body | fromjson' | grep '^{' | jq -s '.' > report.json
            cat response.json | jq -r '.body | fromjson' | grep '^{' | jq -s '.' > report.json

            # Optional: Verify the file was created
            echo "Report created successfully: report.json"
            ls -lh report.json
            cat eport.json
     
      - name: Upload report 
        uses: actions/upload-artifact@v4
        with:
          name: code-Ai-report
          path: report.json


      - name: Format Lambda Output using GithubSummary
        env:
         #LAMBDA_OUTPUT: response.json
         LAMBDA_OUTPUT: '${{ steps.invoke_lambda.outputs.response }}' # Replace with your actual output variable
        run: |
            echo "### ðŸš€ Code Analysis Report" >> $GITHUB_STEP_SUMMARY
    
            # 1. Extract the 'body' string
            # 2. Use 'fromjson' to unescape it
            # 3. Use 'split' to remove the text before the JSON (like the </think> tag)
            # 4. Filter only lines that start with '{' and parse them
            
            echo "$LAMBDA_OUTPUT" | jq -r '.body | fromjson' | \
            grep '^{' | while read -r line; do
            echo "#### File: $(echo "$line" | jq -r '.filename')" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$line" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            done